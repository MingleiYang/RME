#! /bin/sh

if [ $# -lt 4 ] 
then echo "Usage:
	 $0 [traindata] [testdata] [structureDir] [outdir]"
     exit 113
fi
EXEPATH={EXEPATH}

traindata=$1
testdata=$2
structureDir=$3
outdir=$4
pair_ratio=0.534558833156579  # estimated according to a large database of reference structures and used as a constant
mkdir -p $outdir/SHAPE

# 1. quantile normalization on SHAPE reactivity for different RNAs
Rscript $EXEPATH/quantileNormalization.R -i $traindata -o $outdir/SHAPE/`basename $traindata`.normed -n $outdir/SHAPE/SHAPE.quantileTarget.txt -m train
Rscript $EXEPATH/quantileNormalization.R -i $testdata -o $outdir/SHAPE/`basename $testdata`.normed -n $outdir/SHAPE/SHAPE.quantileTarget.txt -m test

# 2. distribution fitting on training RNAs
Rscript $EXEPATH/distributionFitting.R -i $outdir/SHAPE/`basename $traindata`.normed -o $outdir/SHAPE/SHAPE.pairParameter.txt -d gev -c pair
Rscript $EXEPATH/distributionFitting.R -i $outdir/SHAPE/`basename $traindata`.normed -o $outdir/SHAPE/SHAPE.loopParameter.txt -d gamma -c loop

# 3. calculation of posterior paring probabilities
Rscript $EXEPATH/posteriorPairingProb.R -i $outdir/SHAPE/`basename $traindata`.normed -O $outdir/SHAPE -o $outdir/SHAPE/`basename $traindata`.normed.prob.data -r $pair_ratio -p $outdir/SHAPE/SHAPE.pairParameter.txt -l $outdir/SHAPE/SHAPE.loopParameter.txt 
Rscript $EXEPATH/posteriorPairingProb.R -i $outdir/SHAPE/`basename $testdata`.normed -O $outdir/SHAPE -o $outdir/SHAPE/`basename $testdata`.normed.prob.data -r $pair_ratio -p $outdir/SHAPE/SHAPE.pairParameter.txt -l $outdir/SHAPE/SHAPE.loopParameter.txt

# 4. prepare files for training and test
perl $EXEPATH/getFullLenAndStruct.pl $outdir/SHAPE/`basename $traindata`.normed.prob.data train 4 $structureDir/*.ct >$outdir/SHAPE.for-optimize-parameter.txt
perl $EXEPATH/getFullLenAndStruct.pl $outdir/SHAPE/`basename $testdata`.normed.prob.data test 4 $structureDir/*.ct >$outdir/SHAPE.for-test.txt
